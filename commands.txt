#!/usr/bin/env bash

# 1) Convert reference MP3 -> WAV (required for --ref-audio)
ffmpeg -y \
  -i "examples/data/clone_test_sio.mp3" \
  -ac 1 -ar 24000 -c:a pcm_s16le \
  "examples/data/clone_test_sio.wav"

# 2) Voice clone (Base model + ICL: requires --ref-text)
# - Set BASE_MODEL_DIR to your *Base* model directory (0.6B-Base or 1.7B-Base)
# - Replace REF_TEXT with your transcript
BASE_MODEL_DIR="/path/to/Qwen3-TTS-12Hz-1.7B-Base"
REF_TEXT="TRANSCRIPT_GOES_HERE"

docker run --gpus all --rm \
  -v "$BASE_MODEL_DIR:/models/base" \
  -v "$(pwd)/examples/data:/input" \
  -v "$(pwd)/output:/output" \
  qwen3-tts \
    --model-dir /models/base \
    --device cuda \
    --language english \
    --text "Hello world, this is a test." \
    --ref-audio /input/clone_test_sio.wav \
    --ref-text "$REF_TEXT" \
    --output /output/out_icl.wav

# 3) Voice clone run used for SIO test (ICL, CPU fallback)
# Note: CUDA run failed in-container with: CUBLAS_STATUS_NOT_INITIALIZED
docker run --rm \
  -v "$(pwd)/models:/models" \
  -v "$(pwd)/examples/data:/input" \
  -v "$(pwd)/output:/output" \
  qwen3-tts \
    --model-dir /models/Qwen3-TTS-12Hz-1.7B-Base \
    --tokenizer-dir /models/tokenizer/tokenizer.json \
    --device cpu \
    --language korean \
    --duration 15 \
    --text "오빠.. 나 당장 갈 것 같아.. 빨리 보내줬으면 좋겠어. 부탁이야. 제발 안에 해 줄래?" \
    --ref-audio /input/clone_test_sio.wav \
    --ref-text "오빠.. 나 당장 갈 것 같아.. 빨리 보내줬으면 좋겠어. 부탁이야. 제발 안에 해 줄래?" \
    --output /output/sio_clone_icl_cpu.wav

# 4) Download models (curl, resumable)
./scripts/download_models.sh
# Or use a custom location:
# MODEL_ROOT=/path/to/models ./scripts/download_models.sh
