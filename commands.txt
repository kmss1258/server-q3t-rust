#!/usr/bin/env bash

# 1) Convert reference MP3 -> WAV (required for --ref-audio)
ffmpeg -y \
  -i "examples/data/clone_test_sio.mp3" \
  -ac 1 -ar 24000 -c:a pcm_s16le \
  "examples/data/clone_test_sio.wav"

# 2) Voice clone (Base model + ICL: requires --ref-text)
# - Set BASE_MODEL_DIR to your *Base* model directory (0.6B-Base or 1.7B-Base)
# - Replace REF_TEXT with your transcript
BASE_MODEL_DIR="/path/to/Qwen3-TTS-12Hz-1.7B-Base"
REF_TEXT="TRANSCRIPT_GOES_HERE"

docker run --gpus all --rm \
  -v "$BASE_MODEL_DIR:/models/base" \
  -v "$(pwd)/examples/data:/input" \
  -v "$(pwd)/output:/output" \
  qwen3-tts \
    --model-dir /models/base \
    --device cuda \
    --language english \
    --text "Hello world, this is a test." \
    --ref-audio /input/clone_test_sio.wav \
    --ref-text "$REF_TEXT" \
    --output /output/out_icl.wav

# 3) Voice clone run used for SIO test (ICL, CPU fallback)
# Note: CUDA run failed in-container with: CUBLAS_STATUS_NOT_INITIALIZED
docker run --rm \
  -v "$(pwd)/models:/models" \
  -v "$(pwd)/examples/data:/input" \
  -v "$(pwd)/output:/output" \
  qwen3-tts \
    --model-dir /models/Qwen3-TTS-12Hz-1.7B-Base \
    --tokenizer-dir /models/tokenizer/tokenizer.json \
    --device cpu \
    --language korean \
    --duration 15 \
    --text "오빠.. 나 당장 갈 것 같아.. 빨리 보내줬으면 좋겠어. 부탁이야. 제발 안에 해 줄래?" \
    --ref-audio /input/clone_test_sio.wav \
    --ref-text "오빠.. 나 당장 갈 것 같아.. 빨리 보내줬으면 좋겠어. 부탁이야. 제발 안에 해 줄래?" \
    --output /output/sio_clone_icl_cpu.wav

# 4) Download models (curl, resumable)
MODEL_ROOT="$(pwd)/models"
TOKENIZER_DIR="$MODEL_ROOT/tokenizer"
SPEECH_TOKENIZER_DIR="$MODEL_ROOT/speech_tokenizer"
BASE_DIR="$MODEL_ROOT/Qwen3-TTS-12Hz-1.7B-Base"
VOICE_DESIGN_DIR="$MODEL_ROOT/Qwen3-TTS-12Hz-1.7B-VoiceDesign"

mkdir -p "$TOKENIZER_DIR" "$SPEECH_TOKENIZER_DIR" "$BASE_DIR" "$VOICE_DESIGN_DIR"

# Text tokenizer
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen2-0.5B/resolve/main/tokenizer.json" \
  -o "$TOKENIZER_DIR/tokenizer.json"

# Speech tokenizer
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-Tokenizer-12Hz/resolve/main/config.json" \
  -o "$SPEECH_TOKENIZER_DIR/config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-Tokenizer-12Hz/resolve/main/preprocessor_config.json" \
  -o "$SPEECH_TOKENIZER_DIR/preprocessor_config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-Tokenizer-12Hz/resolve/main/model.safetensors" \
  -o "$SPEECH_TOKENIZER_DIR/model.safetensors"

# 1.7B Base
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-Base/resolve/main/config.json" \
  -o "$BASE_DIR/config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-Base/resolve/main/generation_config.json" \
  -o "$BASE_DIR/generation_config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-Base/resolve/main/preprocessor_config.json" \
  -o "$BASE_DIR/preprocessor_config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-Base/resolve/main/tokenizer_config.json" \
  -o "$BASE_DIR/tokenizer_config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-Base/resolve/main/model.safetensors" \
  -o "$BASE_DIR/model.safetensors"

# 1.7B VoiceDesign
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-VoiceDesign/resolve/main/config.json" \
  -o "$VOICE_DESIGN_DIR/config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-VoiceDesign/resolve/main/generation_config.json" \
  -o "$VOICE_DESIGN_DIR/generation_config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-VoiceDesign/resolve/main/preprocessor_config.json" \
  -o "$VOICE_DESIGN_DIR/preprocessor_config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-VoiceDesign/resolve/main/tokenizer_config.json" \
  -o "$VOICE_DESIGN_DIR/tokenizer_config.json"
curl -L -C - --progress-bar \
  "https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-VoiceDesign/resolve/main/model.safetensors" \
  -o "$VOICE_DESIGN_DIR/model.safetensors"
